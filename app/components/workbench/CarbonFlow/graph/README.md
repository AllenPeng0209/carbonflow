# 专业碳足迹可视化系统

## 概述

这是一个专业的碳足迹可视化系统，参考了OpenLCA等专业碳管理软件的设计理念，为碳产品经理提供直观、专业的碳足迹分析工具。系统支持**层次布局**和**桑基图**两种可视化模式。

## 核心特性

### 🌊 桑基图可视化（新功能）
- **流量可视化**：连线粗细直接反映碳足迹流量大小
- **渐变色彩**：基于碳足迹强度的颜色渐变效果
- **节点高度**：节点高度根据碳足迹值动态调整
- **流向清晰**：从排放源到最终产品的清晰流向
- **专业外观**：类似图片中的专业桑基图效果

### 🎯 智能层次布局
- **自上而下的生命周期布局**：最终产品在顶部，各种排放源在底部
- **基于碳足迹的节点排序**：同层级内按碳足迹大小排序，高碳足迹节点居中显示
- **自动间距调整**：根据节点数量自动调整间距，确保最佳视觉效果

### 📊 碳足迹可视化
- **颜色编码系统**：
  - 🔴 红色：高碳足迹 (> 50 kgCO₂e)
  - 🟠 橙色：中等碳足迹 (10-50 kgCO₂e)
  - 🟢 绿色：低碳足迹 (< 10 kgCO₂e)
  - ⚫ 灰色：无数据

- **动态边宽度**：连线粗细基于节点碳足迹值动态调整
- **边标签显示**：显示具体的碳足迹数值
- **动画效果**：高碳足迹连线具有动画效果，突出显示

### 🎨 专业视觉设计
- **现代化UI**：深色主题，专业的视觉效果
- **交互式图例**：实时显示碳足迹强度分级
- **响应式设计**：适配不同屏幕尺寸
- **悬停效果**：节点悬停时的视觉反馈

## 布局模式

### 桑基图布局（推荐）
```
层级 0: 排放源 (Disposal) - 硅矿开采、稀土开采、锂矿开采、煤电等
层级 1: 使用节点 (Usage) - 用电等
层级 2: 分销节点 (Distribution) - 包装、运输等
层级 3: 制造节点 (Manufacturing) - 芯片制造、屏幕制造、电池制造等
层级 4: 产品节点 (Product) - 手机组装等
层级 5: 最终产品 (Final Product) - 智能手机
```

### 层次布局
```
层级 0: 最终产品 (Final Product)
层级 1: 产品节点 (Product)
层级 2: 制造节点 (Manufacturing)
层级 3: 分销节点 (Distribution)
层级 4: 使用节点 (Usage)
层级 5: 废弃节点 (Disposal) - 排放源
```

## 使用方法

### 快速开始
1. **加载演示数据**：点击"📱 加载演示数据"按钮
2. **切换布局模式**：
   - 点击"🌊 桑基图"体验流量可视化
   - 点击"🔄 层次布局"查看传统层次结构

### 布局切换
- **桑基图模式**：适合分析碳足迹流向和贡献度
- **层次布局模式**：适合查看生命周期阶段关系

### 节点交互
- **单击**：选中节点，查看详细信息
- **双击**：编辑节点属性
- **拖拽**：手动调整节点位置

### 连线操作
- **创建连接**：从源节点的连接点拖拽到目标节点
- **删除连接**：选中连线后按Delete键

## 桑基图特性

### 视觉特点
- **流线粗细**：10-60px范围，基于碳足迹值
- **颜色渐变**：绿色(低) → 橙色(中) → 红色(高)
- **节点高度**：40-120px范围，反映碳足迹大小
- **流向动画**：大流量连线具有动画效果

### 算法优势
- **智能布局**：自动计算最佳节点位置
- **流量计算**：基于源节点和目标节点的最小碳足迹值
- **视觉权重**：连线粗细直观反映碳足迹贡献

## 演示数据

系统内置智能手机完整生命周期演示数据：

### 节点类型
- **排放源**：硅矿开采(28.4)、稀土开采(16.8)、锂矿开采(12.7)、煤电(22.3)
- **制造**：芯片制造(45.2)、屏幕制造(18.7)、电池制造(15.3)
- **分销**：包装(2.1)、运输(3.8)
- **使用**：用电(25.6)
- **产品**：手机组装(12.5)
- **最终产品**：智能手机(85.5)

### 连接关系
完整的12条连接关系，展示从原材料到最终产品的碳足迹流向。

## 技术实现

### 桑基图算法
- **路径生成**：贝塞尔曲线路径计算
- **流量映射**：碳足迹值到视觉宽度的映射
- **颜色插值**：基于强度的渐变色计算
- **布局优化**：层级内节点的智能排列

### 核心算法
- **层次布局算法**：基于节点类型的预定义层级
- **碳足迹权重计算**：动态计算边的视觉权重
- **颜色映射算法**：基于碳足迹值的智能颜色分配

### 性能优化
- **延迟布局**：避免频繁的布局计算
- **状态同步**：本地状态与全局store的高效同步
- **内存管理**：及时清理定时器和事件监听器

## 配置参数

### 桑基图配置
```typescript
const SANKEY_CONFIG = {
  LAYER_HEIGHT: 200,     // 层间距
  NODE_WIDTH: 200,       // 节点宽度
  NODE_MIN_HEIGHT: 40,   // 节点最小高度
  NODE_MAX_HEIGHT: 120,  // 节点最大高度
  LAYER_PADDING: 100,    // 层边距
  NODE_PADDING: 20,      // 节点间距
  CURVE_TENSION: 0.5,    // 曲线张力
};
```

### 层次布局配置
```typescript
const LAYOUT_CONFIG = {
  LAYER_HEIGHT: 180,     // 层间距
  NODE_SPACING: 280,     // 节点间距
  START_Y: 100,          // 起始Y坐标
  START_X: 100,          // 起始X坐标
  EDGE_MIN_WIDTH: 2,     // 边的最小宽度
  EDGE_MAX_WIDTH: 8,     // 边的最大宽度
};
```

## 扩展功能

### 已实现功能
- ✅ 桑基图可视化
- ✅ 层次布局
- ✅ 演示数据加载
- ✅ 布局模式切换
- ✅ 碳足迹图例

### 计划中的功能
- [ ] 多种布局算法选择
- [ ] 碳足迹热力图
- [ ] 导出为PDF/PNG
- [ ] 3D可视化模式
- [ ] 时间序列动画

### 自定义选项
- [ ] 可配置的颜色主题
- [ ] 自定义碳足迹阈值
- [ ] 节点样式模板

## 最佳实践

1. **数据准备**：确保节点包含准确的碳足迹数据
2. **布局选择**：
   - 分析流向时使用桑基图
   - 查看层级关系时使用层次布局
3. **连接关系**：建立清晰的上下游关系
4. **定期更新**：及时更新碳足迹数据

## 故障排除

### 常见问题
1. **布局不生效**：检查节点数据是否完整
2. **桑基图显示异常**：确认碳足迹数据格式正确
3. **连线显示异常**：确认边的源节点和目标节点存在
4. **性能问题**：减少同时显示的节点数量

### 调试模式
在浏览器控制台中可以看到详细的布局日志：
```
[Sankey Layout] 开始桑基图布局
[Sankey Layout] 布局完成，节点数: X, 边数: Y
[CarbonFootprint Layout] 开始专业碳足迹层次布局
[CarbonFootprint Layout] 布局完成，节点数: X, 边数: Y
```

## 贡献指南

欢迎提交Issue和Pull Request来改进这个可视化系统。请确保：
1. 遵循现有的代码风格
2. 添加适当的测试
3. 更新相关文档

## 许可证

本项目采用MIT许可证。 